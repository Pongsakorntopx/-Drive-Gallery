<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Google Drive</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {font-family:'Prompt',sans-serif;background:#e0e5ec;margin:0;padding:0;text-align:center;}
    #googleAuthArea { margin: 18px 0 0 0; }
    .btn { background:#1976d2;color:#fff;border:none;border-radius:8px;padding:0.7em 1.5em;cursor:pointer;font-size:1.1rem; }
    .gallery {display: grid;grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));gap: 20px;padding: 20px;}
    .image-item {background-color: #e0e5ec;border-radius: 12px;text-align: center;padding: 8px;}
    .image-item img { border-radius: 8px; cursor: pointer; width: 100%; height: auto;}
    #notification {
      position: fixed; top: 10px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: #fff;
      padding: 10px 20px; border-radius: 5px;
      z-index: 3000; display: none;
      opacity: 0; transition: opacity 0.5s ease;
    }
    .warnbox {margin:18px auto 8px auto;max-width:480px;background:#fffbe6;color:#b8731c;border:1px solid #ffd591;border-radius:8px;font-size:1.09rem;padding:12px 18px;text-align:left;}
    .warnbox b { color: #ff9800; }
  </style>
</head>
<body>
  <div id="googleAuthArea">
    <button class="btn" id="login-btn" onclick="handleAuthClick()">üîë Login with Google</button>
    <button class="btn" id="logout-btn" onclick="handleSignoutClick()" style="display:none;">Logout</button>
    <span id="user-email" style="margin-left: 15px; font-size:1.1rem;"></span>
  </div>
  <div class="warnbox" id="shareHint" style="display:none;">
    ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå <b>‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô ‚ÄúAnyone with the link‚Äù</b> (‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ)<br>
    ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∂‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå public ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  </div>
  <div id="chooseFolderArea" style="display:none;margin:18px 0;">
    <select id="folderSelect" style="min-width:240px;"></select>
    <button class="btn" onclick="onPickFolder()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
  </div>
  <div class="gallery" id="gallery"></div>
  <div id="notification"></div>
<script>
  const CLIENT_ID = '258829783034-fthiotfelubgc5v5cr1l96fj2ta02v3u.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';

  let accessToken = null;
  let userEmail = null;
  let pickedFolderId = null;
  let allImages = [];

  function onGAPILoad() {
    gapi.load('client', async function() {
      await gapi.client.init({
        discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
      });
      document.getElementById('login-btn').disabled = false;
    });
  }
  window.addEventListener('load', () => {
    if (window.gapi) onGAPILoad();
    else {
      let timer = setInterval(()=>{
        if(window.gapi) {
          clearInterval(timer); onGAPILoad();
        }
      }, 100);
    }
  });

  window.handleAuthClick = function() {
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById('login-btn').style.display = "none";
        document.getElementById('logout-btn').style.display = "inline-block";
        await getUserEmail();
        await listMyFolders();
        document.getElementById('chooseFolderArea').style.display = "";
        document.getElementById('shareHint').style.display = "block";
        showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    });
    tokenClient.requestAccessToken();
  };
  window.handleSignoutClick = function() {
    accessToken = null;
    userEmail = null;
    document.getElementById('user-email').innerHTML = '';
    document.getElementById('login-btn').style.display = "inline-block";
    document.getElementById('logout-btn').style.display = "none";
    document.getElementById('chooseFolderArea').style.display = "none";
    document.getElementById('gallery').innerHTML = '';
    document.getElementById('shareHint').style.display = "none";
    showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
  };

  async function getUserEmail() {
    let res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: {Authorization: `Bearer ${accessToken}`}
    });
    let info = await res.json();
    userEmail = info.email || '';
    document.getElementById('user-email').innerHTML = userEmail ? `üë§ ${userEmail}` : '';
  }

  async function listMyFolders() {
    document.getElementById('folderSelect').innerHTML = "<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå...</option>";
    let pageToken = null, folders = [];
    do {
      let res = await gapi.client.drive.files.list({
        q: `mimeType = 'application/vnd.google-apps.folder' and trashed = false and 'me' in owners`,
        fields: "nextPageToken,files(id,name)",
        pageToken: pageToken,
        pageSize: 100,
        supportsAllDrives: true,
        includeItemsFromAllDrives: true,
      });
      folders = folders.concat(res.result.files);
      pageToken = res.result.nextPageToken;
    } while (pageToken);
    let sel = document.getElementById('folderSelect');
    if(folders.length === 0) {
      sel.innerHTML = "<option value=''>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</option>";
      pickedFolderId = null;
    } else {
      sel.innerHTML = folders.map(f=>`<option value="${f.id}">${f.name}</option>`).join("");
      pickedFolderId = folders[0].id;
    }
    document.getElementById('shareHint').style.display = "block";
  }

  function onPickFolder() {
    let sel = document.getElementById('folderSelect');
    pickedFolderId = sel.value;
    if (!pickedFolderId) {
      showNotification("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå");
      document.getElementById('gallery').innerHTML = '';
      return;
    }
    fetchImagesInFolder(pickedFolderId);
  }

  async function fetchImagesInFolder(folderId) {
    document.getElementById('gallery').innerHTML = '';
    try {
      let res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and mimeType contains 'image/' and trashed = false`,
        fields: "files(id,name,createdTime)",
        pageSize: 100,
        supportsAllDrives: true,
        includeItemsFromAllDrives: true,
      });
      let files = res.result.files || [];
      allImages = files.sort((a,b)=>new Date(b.createdTime)-new Date(a.createdTime));
      displayImages(allImages);
    } catch (err) {
      document.getElementById('gallery').innerHTML = "<div>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û</div>";
    }
  }

  function displayImages(images) {
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = images.map((image,i) => `
      <div class="image-item" data-driveid="${image.id}">
        <img src="https://drive.google.com/uc?export=view&id=${image.id}" 
             alt="${image.name}" style="width:100%;max-width:400px;">
      </div>
    `).join('');
  }

  function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = "block";
    setTimeout(() => { notification.style.opacity = "1"; }, 100);
    setTimeout(() => {
      notification.style.opacity = "0";
      setTimeout(() => { notification.style.display = "none"; }, 500);
    }, 3000);
  }
</script>
</body>
</html>
