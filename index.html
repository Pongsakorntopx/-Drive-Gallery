<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Google Drive Public Folder Gallery</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Prompt:400,700&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Prompt',sans-serif;background:#f6f8fc;margin:0;}
    header {background:#1976d2;color:#fff;padding:1.1rem 1rem;font-size:1.6rem;}
    .main {max-width:980px;margin:2.5rem auto;background:#fff;border-radius:18px;box-shadow:0 4px 32px #0002;padding:2rem;}
    .btn {background:#1976d2;color:#fff;border:none;border-radius:8px;padding:0.7em 1.5em;cursor:pointer;font-size:1.08rem;}
    #gallery {display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:1.3rem;}
    .card {background:#f7fafd;border-radius:1em;box-shadow:0 2px 12px #0001;overflow:hidden;transition:box-shadow .23s;}
    .card:hover {box-shadow: 0 4px 24px #1976d255;}
    .card img {width:100%;display:block;transition:transform 0.24s;cursor:pointer;background:#eee;}
    .card img:hover {transform:scale(1.06);box-shadow:0 8px 24px #0002;}
    .card .title {font-size:1rem;padding:0.5em 1em;color:#1976d2;}
    .info {color:#555;font-size:1.07rem;margin-bottom:1.2em;}
    select {font-size:1.09rem;padding:0.38em 1em;border-radius:8px;}
  </style>
</head>
<body>
<header>
  Google Drive Public Folder Gallery
</header>
<div class="main">
  <div id="auth-area">
    <button class="btn" id="login-btn" onclick="handleAuthClick()">üîë Login with Google</button>
    <button class="btn" id="logout-btn" onclick="handleSignoutClick()" style="display:none;">Logout</button>
  </div>
  <div id="step2" style="display:none;">
    <div class="info">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive <b>(‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ö‡∏ö Anyone with the link)</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ</div>
    <select id="public-folders" style="min-width:220px;"></select>
    <button class="btn" id="show-btn" onclick="loadSelectedFolder()" style="margin-left:1.2em;">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    <span id="folder-info"></span>
  </div>
  <div id="gallery"></div>
  <div id="loading" style="text-align:center;margin:1.7rem;display:none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
</div>

<script>
  // ====== CONFIG ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ======
  const CLIENT_ID = '258829783034-fthiotfelubgc5v5cr1l96fj2ta02v3u.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyA1shyUv4z3r__x2FGsZp-C9Pcmwl_1qHk';
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
  // ===========================

  let tokenClient;
  let accessToken = null;
  let publicFolders = [];

  // 1. Load GAPI & Picker
  function onGAPILoad() {
    gapi.load('client', async function() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
      });
      document.getElementById('login-btn').disabled = false;
    });
  }
  window.addEventListener('load', () => {
    if (window.gapi) onGAPILoad();
    else {
      let timer = setInterval(()=>{
        if(window.gapi) {
          clearInterval(timer); onGAPILoad();
        }
      }, 100);
    }
  });

  // 2. Login with Google
  window.handleAuthClick = function() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById('login-btn').style.display = "none";
        document.getElementById('logout-btn').style.display = "inline-block";
        document.getElementById('step2').style.display = "";
        await listPublicFolders();
        showNotify('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      },
      error_callback: (err) => {
        showNotify('Google login failed: ' + (err && err.error_description ? err.error_description : 'Unknown'));
      }
    });
    tokenClient.requestAccessToken();
  };

  // 3. Logout
  window.handleSignoutClick = function() {
    accessToken = null;
    document.getElementById('login-btn').style.display = "inline-block";
    document.getElementById('logout-btn').style.display = "none";
    document.getElementById('step2').style.display = "none";
    document.getElementById('gallery').innerHTML = "";
    document.getElementById('folder-info').innerHTML = "";
    document.getElementById('public-folders').innerHTML = "";
    showNotify('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
  };

  // 4. List only shared folders (Anyone with the link)
  async function listPublicFolders() {
    document.getElementById('public-folders').innerHTML = "<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</option>";
    publicFolders = [];
    let pageToken = null, folders = [];
    do {
      let res = await gapi.client.drive.files.list({
        q: `mimeType = 'application/vnd.google-apps.folder' and trashed = false and 'me' in owners`,
        fields: "nextPageToken,files(id,name,permissions)",
        pageToken: pageToken,
        pageSize: 100,
        supportsAllDrives: true,
        includeItemsFromAllDrives: true,
      });
      folders = folders.concat(res.result.files);
      pageToken = res.result.nextPageToken;
    } while (pageToken);

    // filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà permission ‡πÄ‡∏õ‡πá‡∏ô anyone can read
    publicFolders = folders.filter(f=>{
      if (!f.permissions) return false;
      return f.permissions.some(p => p.type=="anyone" && (p.role=="reader" || p.role=="writer" || p.role=="owner"));
    });

    let sel = document.getElementById('public-folders');
    if(publicFolders.length === 0) {
      sel.innerHTML = "<option value=''>-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô Anyone with the link --</option>";
    } else {
      sel.innerHTML = publicFolders.map(f=>`<option value="${f.id}">${f.name}</option>`).join("");
    }
  }

  // 5. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å folder ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‚Äù
  async function loadSelectedFolder() {
    let sel = document.getElementById('public-folders');
    let folderId = sel.value;
    if (!folderId) return showNotify("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå");
    let folderName = sel.options[sel.selectedIndex].text;
    document.getElementById('folder-info').innerHTML = `üìÇ <b>${folderName}</b>`;
    await listImagesInFolder(folderId);
  }

  // 6. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö Anyone with the link (public link)
  async function listImagesInFolder(folderId) {
    document.getElementById('gallery').innerHTML = "";
    document.getElementById('loading').style.display = "block";
    try {
      let res = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and mimeType contains 'image/' and trashed = false`,
        fields: "files(id,name)",
        pageSize: 100,
        supportsAllDrives: true,
        includeItemsFromAllDrives: true,
      });
      let files = res.result.files || [];
      let html = "";
      files.forEach(f=>{
        let imgSrc = `https://drive.google.com/uc?export=view&id=${f.id}`;
        html += `<div class="card">
          <img src="${imgSrc}" alt="${f.name}" loading="lazy">
          <div class="title">${f.name}</div>
        </div>`;
      });
      document.getElementById('gallery').innerHTML = html || "<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</div>";
    } catch (err) {
      showNotify("‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+(err.result && err.result.error && err.result.error.message?err.result.error.message:err.message));
    }
    document.getElementById('loading').style.display = "none";
  }

  // 7. Notify
  function showNotify(msg) {
    let d = document.createElement('div');
    d.style = "position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#fffbe2;padding:0.6em 2em;border-radius:1.2em;box-shadow:0 4px 32px #0002;z-index:1111;color:#444;font-size:1.1em;";
    d.innerHTML = msg;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1700);
  }
</script>
</body>
</html>
